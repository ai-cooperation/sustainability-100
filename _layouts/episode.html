---
layout: default
---
<article class="episode-detail">
  <div class="episode-header">
    <a href="{{ '/' | relative_url }}" class="back-link">&larr; 回首頁</a>
    <span class="series-badge">{{ page.series }} {{ page.series_name }}</span>
    <h1>{{ page.ep_id }}｜{{ page.title }}</h1>
    <p class="outline">{{ page.outline }}</p>
    <time>{{ page.date | date: "%Y-%m-%d" }}</time>
  </div>

  <!-- English Podcast -->
  {% assign en_audio = page.podcast_en | default: page.podcast_audio %}
  {% if en_audio %}
  <section class="podcast-section">
    <h2>{{ page.podcast_en_title | default: "Podcast (English)" }}</h2>
    <div class="podcast-player" data-lang="en">
      <audio id="audio-en" preload="metadata">
        <source src="{{ '/assets/audio/' | append: page.ep_id | append: '/' | append: en_audio | relative_url }}" type="audio/mp4">
      </audio>
      <div class="player-controls">
        <button class="play-btn" data-target="audio-en" aria-label="Play/Pause">
          <svg class="icon-play" viewBox="0 0 24 24" width="28" height="28"><polygon points="5,3 19,12 5,21" fill="currentColor"/></svg>
          <svg class="icon-pause" viewBox="0 0 24 24" width="28" height="28" style="display:none"><rect x="6" y="4" width="4" height="16" fill="currentColor"/><rect x="14" y="4" width="4" height="16" fill="currentColor"/></svg>
        </button>
        <div class="progress-container">
          <div class="player-progress">
            <div class="player-progress-fill"></div>
          </div>
          <div class="time-display">
            <span class="current-time">0:00</span> / <span class="total-time">0:00</span>
          </div>
        </div>
        <select class="speed-select" data-target="audio-en">
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </div>
    </div>
    {% if page.transcript_en %}
    <div class="transcript-download">
      <a href="{{ '/assets/audio/' | append: page.ep_id | append: '/' | append: page.transcript_en | relative_url }}" download class="download-btn">
        <svg viewBox="0 0 24 24" width="16" height="16"><path d="M12 16l-6-6h4V4h4v6h4l-6 6z" fill="currentColor"/><path d="M4 18h16v2H4v-2z" fill="currentColor"/></svg>
        Download Transcript (EN)
      </a>
    </div>
    {% endif %}
  </section>
  {% endif %}

  <!-- Chinese Podcast -->
  {% if page.podcast_zh %}
  <section class="podcast-section">
    <h2>{{ page.podcast_zh_title | default: "Podcast（中文）" }}</h2>
    <div class="podcast-player" data-lang="zh">
      <audio id="audio-zh" preload="metadata">
        <source src="{{ '/assets/audio/' | append: page.ep_id | append: '/' | append: page.podcast_zh | relative_url }}" type="audio/mp4">
      </audio>
      <div class="player-controls">
        <button class="play-btn" data-target="audio-zh" aria-label="Play/Pause">
          <svg class="icon-play" viewBox="0 0 24 24" width="28" height="28"><polygon points="5,3 19,12 5,21" fill="currentColor"/></svg>
          <svg class="icon-pause" viewBox="0 0 24 24" width="28" height="28" style="display:none"><rect x="6" y="4" width="4" height="16" fill="currentColor"/><rect x="14" y="4" width="4" height="16" fill="currentColor"/></svg>
        </button>
        <div class="progress-container">
          <div class="player-progress">
            <div class="player-progress-fill"></div>
          </div>
          <div class="time-display">
            <span class="current-time">0:00</span> / <span class="total-time">0:00</span>
          </div>
        </div>
        <select class="speed-select" data-target="audio-zh">
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </div>
    </div>
    {% if page.transcript_zh %}
    <div class="transcript-download">
      <a href="{{ '/assets/audio/' | append: page.ep_id | append: '/' | append: page.transcript_zh | relative_url }}" download class="download-btn">
        <svg viewBox="0 0 24 24" width="16" height="16"><path d="M12 16l-6-6h4V4h4v6h4l-6 6z" fill="currentColor"/><path d="M4 18h16v2H4v-2z" fill="currentColor"/></svg>
        下載逐字稿（中文）
      </a>
    </div>
    {% endif %}
  </section>
  {% endif %}

  <!-- Video -->
  {% assign video_src = page.video_file | default: page.video_overview %}
  {% if video_src %}
  <section class="video-section">
    <h2>{% if page.video_overview %}Video Overview{% else %}影片{% endif %}</h2>
    <video controls preload="metadata" playsinline>
      <source src="{{ '/assets/video/' | append: page.ep_id | append: '/' | append: video_src | relative_url }}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </section>
  {% endif %}

  {% if page.slides and page.slides.size > 0 %}
  <section class="slides-section">
    <h2>簡報圖卡</h2>
    <div class="slides-grid">
      {% for slide in page.slides %}
      <div class="slide-card">
        {% if slide.image and slide.image != "" %}
        <img src="{{ '/assets/images/' | append: page.ep_id | append: '/' | append: slide.image | relative_url }}"
             alt="{{ slide.title }}" loading="lazy">
        {% endif %}
        <h3>{{ slide.title }}</h3>
        <ul>
          {% for point in slide.points %}
          <li>{{ point }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="research-content">
    <h2>研究報告</h2>
    {{ content }}
  </section>

  <nav class="episode-nav">
    {% assign sorted = site.episodes | sort: "number" %}
    {% for ep in sorted %}
      {% if ep.number == page.number %}
        {% assign idx = forloop.index0 %}
      {% endif %}
    {% endfor %}
    {% assign prev_idx = idx | minus: 1 %}
    {% assign next_idx = idx | plus: 1 %}
    {% if prev_idx >= 0 %}
      <a href="{{ sorted[prev_idx].url | relative_url }}" class="nav-prev">&larr; {{ sorted[prev_idx].ep_id }}</a>
    {% endif %}
    {% if next_idx < sorted.size %}
      <a href="{{ sorted[next_idx].url | relative_url }}" class="nav-next">{{ sorted[next_idx].ep_id }} &rarr;</a>
    {% endif %}
  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const players = document.querySelectorAll('.podcast-player');
  const allAudios = document.querySelectorAll('audio');

  players.forEach(function(player) {
    const audio = player.querySelector('audio');
    const playBtn = player.querySelector('.play-btn');
    const iconPlay = playBtn.querySelector('.icon-play');
    const iconPause = playBtn.querySelector('.icon-pause');
    const progressFill = player.querySelector('.player-progress-fill');
    const progressBar = player.querySelector('.player-progress');
    const currentTime = player.querySelector('.current-time');
    const totalTime = player.querySelector('.total-time');
    const speedSelect = player.querySelector('.speed-select');

    function formatTime(s) {
      if (isNaN(s)) return '0:00';
      var m = Math.floor(s / 60);
      var sec = Math.floor(s % 60);
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }

    playBtn.addEventListener('click', function() {
      if (audio.paused) {
        allAudios.forEach(function(a) {
          if (a !== audio && !a.paused) {
            a.pause();
            var otherPlayer = a.closest('.podcast-player');
            otherPlayer.querySelector('.icon-play').style.display = '';
            otherPlayer.querySelector('.icon-pause').style.display = 'none';
          }
        });
        audio.play();
        iconPlay.style.display = 'none';
        iconPause.style.display = '';
      } else {
        audio.pause();
        iconPlay.style.display = '';
        iconPause.style.display = 'none';
      }
    });

    audio.addEventListener('timeupdate', function() {
      if (audio.duration) {
        progressFill.style.width = (audio.currentTime / audio.duration * 100) + '%';
        currentTime.textContent = formatTime(audio.currentTime);
      }
    });

    audio.addEventListener('loadedmetadata', function() {
      totalTime.textContent = formatTime(audio.duration);
    });

    audio.addEventListener('ended', function() {
      iconPlay.style.display = '';
      iconPause.style.display = 'none';
    });

    progressBar.addEventListener('click', function(e) {
      var rect = progressBar.getBoundingClientRect();
      var pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    speedSelect.addEventListener('change', function() {
      audio.playbackRate = parseFloat(this.value);
    });
  });
});
</script>
